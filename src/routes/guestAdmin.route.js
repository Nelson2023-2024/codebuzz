// routes/guestAdmin.route.js
import { Router } from "express";
import { Guest } from "../models/Guest.model.js";
import bcrypt from 'bcryptjs'; // Import bcrypt here

const router = Router();

router.post('/admin/guests', async (req, res) => {
    try {
        const { firstName, lastName, email, phone, company, password, role } = req.body; // Destructure password and role

        // Basic validation for required fields
        if (!firstName || !lastName || !email || !password) { // password is now required
            return res.status(400).json({ error: 'All Fields are required' });
        }

        // --- Hash the password before creating the guest ---
        const salt = await bcrypt.genSalt(10); // Generate a salt (adjust complexity as needed)
        const hashedPassword = await bcrypt.hash(password, salt); // Hash the provided password

        // Create a new Guest instance
        const newGuest = new Guest({
            firstName,
            lastName,
            email,
            phone,
            company,
            password: hashedPassword, // Store the hashed password
            role: role || 'guest', // Assign role, default to 'guest' if not provided
            // invitationToken is automatically generated by the schema default
            // isActive defaults to true by schema default
        });

        // Save the new guest to the database
        await newGuest.save();

        // Avoid sending the password back in the response, even if hashed
        const guestResponse = newGuest.toObject();

        res.status(201).json({
            message: 'Guest created successfully',
            guest: guestResponse // Send back the guest object without password
        });
    } catch (error) {
        console.error('Create guest error:', error);
        if (error.code === 11000) { // MongoDB duplicate key error (e.g., email already exists)
            return res.status(400).json({ error: 'A guest with this email already exists.' });
        }
        res.status(500).json({ error: error.message || 'Internal server error during guest creation.' });
    }
});

export { router as guestAdminRoute };